---
title: "ã€Next.jsã€‘AppRouterã§ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã£ã¦ã¿ãŸï¼ï¼"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "AppRouter", "TypeScript", "Docker", "React"]
published: false
---

# ã¯ã˜ã‚ã«

Next.js 13ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸAppRouterã‚’æ´»ç”¨ã—ã¦ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ã‚ªãƒ¼ãƒ ã‚’ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒ»ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã¨ã—ã¦ä½œã£ã¦ã¿ã¾ã™ã€‚

# ä½¿ç”¨æŠ€è¡“

ä»¥ä¸‹ã®ç‰©ã‚’ä½¿ç”¨

- Next.jsï¼ˆAppRouterï¼‰
- TypeScript
- Chakra UI
- MySQL
- Docker

# ç’°å¢ƒæ§‹ç¯‰

ç©ºã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ã™ã‚‹

```
.
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ app
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ initdb.d
â”‚Â Â  â””â”€â”€ create-table.sql
â””â”€â”€ mysql
 Â Â  â””â”€â”€ my.cnf
```

`Dockerfile`ã«ã¯ä»¥ä¸‹ã‚’è¨˜è¿°

```Dockerfile
FROM node:lts-alpine  
WORKDIR /app
```

`docker-compose.yml`ã«ã¯ä»¥ä¸‹ã‚’è¨˜è¿°

```yml
version: '3'
services:
  app:
    container_name: app
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./app:/app
    command: sh -c "npm run dev"
    tty: true
    ports:
      - 3000:3000
    environment:
      - DB_HOST=${MYSQL_HOST}
      - DB_PORT=${MYSQL_PORT}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_DATABASE=${MYSQL_DATABASE}
    depends_on:
      - mysql
  mysql:
    container_name: db
    image: mysql:latest
    restart: always
    ports:
      - ${MYSQL_PORT}:${MYSQL_PORT}
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - TZ=${TZ} # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
    volumes:
      - ./initdb.d:/docker-entrypoint-initdb.d # DBã®åˆæœŸãƒ‡ãƒ¼ã‚¿
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf # bashã§æ—¥æœ¬èªæ–‡å­—åŒ–ã‘ã™ã‚‹å•é¡Œã®è§£æ±º
```

`/initdb.d/create-table.sql`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹

```sql
CREATE TABLE contact_table (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    content_question TEXT NOT NULL,
    postdate DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6)
);
```

`/mysql/my.cnf`ã¯ä»¥ä¸‹

```conf
[mysqld]
character_set_server = utf8mb4
collation-server=utf8mb4_unicode_ci

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
```

`.gitignore`

```gitignore
.DS_Store

.env.local
.env
```

`.env`

```
MYSQL_HOST=mysql
MYSQL_USER=root
MYSQL_PORT=3306
MYSQL_PASSWORD=password
MYSQL_DATABASE=contactform
TZ=Asia/Tokyo
```

å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒã§ããŸã®ã§ã“ã‚Œã‹ã‚‰Next.jsã®ç’°å¢ƒã‚’ä½œæˆã—ã¾ã™ã€‚
ä»¥ä¸‹ã‚’å®Ÿè¡Œ

```sh
docker compose run --rm app npx create-next-app
```

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯ã€Œ.ã€ã‚’å…¥åŠ›
- TypeScriptã‚’é¸æŠ
- ESLintã‚’é¸æŠ
- Tailwind CSSã‚’é¸æŠ
- `src/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½¿ã†ã‚’é¸æŠ
- App Routerã‚’é¸æŠ

![](https://storage.googleapis.com/zenn-user-upload/8a097e079b6d-20231205.png)

ã“ã‚Œã§`/app`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«Next.jsã®ç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚

è©¦ã—ã«èµ·å‹•ã™ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†

```sh
docker compose down # å¿µã®ç‚ºã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¿®äº†
docker compose up -d
```

`localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Next.jsã®ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ã€‚

```sh
docker exec -it db sh # ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã‚‹
mysql -u root -p # DBã«ãƒ­ã‚°ã‚¤ãƒ³
use contactform; # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠ
show tables; # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º

exit # è¡¨ç¤ºã§ããŸã‚‰SQLã‚’çµ‚äº†
exit # ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚‚å‡ºã‚‹
```

ã“ã‚Œã§`contact_table`ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã†ã¾ããƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å‹•ã„ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f954915461ce-20231208.png)

æ¬¡ã«ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã—ã¾ã™ã€‚

```sh
docker exec -it ap sh # ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã‚‹
npm i framer-motion mysql2
npm i -D @chakra-ui/react @emotion/react @emotion/styled @types/mysql
exit # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å‡ºã‚‹
```

# åˆæœŸè¨­å®š

`/app/globals.css`ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

`/app/layout.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```diff
- import './globals.css'
import { Inter } from 'next/font/google'
+ import { ChakraProvider } from "@chakra-ui/react"

const inter = Inter({ subsets: ['latin'] })

export const metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
-       <body className={inter.className}>{children}</body>
+       <body className={inter.className}>
+           <ChakraProvider>{children}</ChakraProvider>
+       </body>
    </html>
  )
}
```

# ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ã®å®Ÿè£…

`/app/page.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx
"use client"
import { Box, Button, Center, FormLabel, Heading, Input, Textarea } from "@chakra-ui/react"
import { ChangeEvent, FormEvent, useState } from "react"

export default function Home() {
  const [userName, setUserName] = useState<string>("")
  const userNameChange = (e: ChangeEvent<HTMLInputElement>) => {
    setUserName(e.currentTarget.value)
  }
  const [userEmail, setUserEmail] = useState<string>("")
  const userEmailChange = (e: ChangeEvent<HTMLInputElement>) => {
    setUserEmail(e.currentTarget.value)
  }
  const [userContent, setUserContent] = useState<string>("")
  const userContentChange = (e: ChangeEvent<HTMLTextAreaElement>) => {
    setUserContent(e.currentTarget.value)
  }

  const onSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault()

    try {
      // é€ä¿¡å‡¦ç†
      const response = await fetch("/api/send", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: userName,
          email: userEmail,
          content: userContent
        })
      })
  
      const json = await response.json()
      console.log(json.message);
      
      if (response.status === 200) {
        setUserName("")
        setUserEmail("")
        setUserContent("")
      }
    } catch (error) {
      console.log("é€ä¿¡å¤±æ•—", error);
    }

    
  }
  return (
    <Center w="full" flexDir="column">
      <Heading py={5}>ãŠå•åˆã›ãƒ•ã‚©ãƒ¼ãƒ </Heading>
      <form onSubmit={onSubmit} style={{width: "100%"}}>
        <Center gap={3} flexDir="column">
          <Box w="40%" minW="250px">
            <FormLabel htmlFor='name'>åå‰</FormLabel>
            <Input id='name' placeholder='åå‰' value={userName} onChange={userNameChange}/>
          </Box>
          <Box w="40%" minW="250px">
            <FormLabel htmlFor='email'>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</FormLabel>
            <Input id='email' placeholder='ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹' value={userEmail} onChange={userEmailChange}/>
          </Box>
          <Box w="40%" minW="250px">
            <FormLabel htmlFor='content'>å†…å®¹</FormLabel>
            <Textarea id='content' placeholder='å†…å®¹' value={userContent} onChange={userContentChange}/>
          </Box>
          <Box w="40%" minW="250px" textAlign="center">
            <Button type="submit">é€ä¿¡</Button>
          </Box>
        </Center>
      </form>
    </Center>
  )
}
```

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®æ¥ç¶š

`/app/lib/db`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€`/db`å†…ã«`connection.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts
// src/lib/connection.ts

import mysql from 'mysql2/promise';

const mysql_connection = async () =>
  await mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_DATABASE,
  });

export default mysql_connection;
```

# é€ä¿¡ã®APIã®å®Ÿè£…

`/app/api/send`ã®ãƒ‘ã‚¹ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šã€`/send`å†…ã«`route.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚

```ts
import mysql_connection from "@/lib/db/connection";
import { NextRequest } from "next/server";

export async function POST(request: NextRequest) {
  const body = await request.json();

  if (!body.name || !body.email || !body.content) {
    return new Response(JSON.stringify({ message: "å…¥åŠ›å€¤ãŒä¸æ­£ã§ã™ã€‚" }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    });
  }

  try {
    const connection = await mysql_connection();

    const query =
      "INSERT INTO contact_table (name, email, content_question) VALUES (?, ?, ?)";
    await connection.execute(query, [body.name, body.email, body.content]);

    return new Response(JSON.stringify({ message: "é€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸã€‚" }), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error) {
    return new Response(JSON.stringify({ message: "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" }), {
      status: 500,
      headers: { "Content-Type": "application/json" },
    });
  }
}
```

ã“ã‚Œã§é€ä¿¡æ©Ÿèƒ½ã®å®Ÿè£…ãŒã§ãã¾ã—ãŸã€‚
è©¦ã—ã«`localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

é€ä¿¡ã§ããŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§DBã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```sh
docker exec -it db sh # ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã‚‹
mysql -u root -p # DBã«ãƒ­ã‚°ã‚¤ãƒ³
use contactform; # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠ
select * from contact_table;
```

é€ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°ã“ã‚Œã§å®Œæˆã§ã™ã€‚